<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redirecting...</title>
    <style>
      :root {
        --primary: #0969da;
        --bg: #f3f6f9;
        --text: #24292f;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        text-align: center;
      }
      .container {
        padding: 2rem;
      }
      .spinner {
        border: 3px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--primary);
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #message {
        font-size: 1.1rem;
        color: #57606a;
      }
      .error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: none;
      }
      .home-btn {
        display: none;
        margin-top: 1.5rem;
        background-color: var(--primary);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        transition: background-color 0.2s;
      }
      .home-btn:hover {
        background-color: #0a58ca;
      }
      /* Hide logs by default */
      .log-entry { display: none; }
    </style>
    <script>
      /**
       * Configuration goes here
       */
      // Format: https://api.github.com/repos/{owner}/{repo}/issues/
      var GITHUB_ISSUES_LINK =
        "https://api.github.com/repos/Ezharjan/url/issues/";
      // Set to 0 for custom domains, 1 for https://<user>.github.io/<repo>/
      // Leave as null to auto-detect.
      var PATH_SEGMENTS_TO_SKIP = null;

      /**
       * DO NOT TOUCH ANYTHING BELOW THIS COMMENT UNLESS YOU KNOW WHAT YOU ARE DOING
       */
      
      function log(msg, type) {
          console.log(msg); // Keep console logs
      }

      function showMessage(msg, isError) {
        var el = document.getElementById("message");
        if (el) el.textContent = msg;
        if (isError) {
           document.querySelector(".spinner").style.display = "none";
           var icon = document.querySelector(".error-icon");
           if (icon) {
             icon.style.display = "block";
             icon.textContent = "ðŸ˜•";
           }
           var btn = document.querySelector(".home-btn");
           if (btn) btn.style.display = "inline-block";
        }
      }

      function isUrl(string) {
        try {
          var url = new URL(string);
          return true;
        } catch (e) {
          return false;
        }
      }

      function decodeBase64(string) {
        try {
          return decodeURIComponent(
            escape(atob(string.replace(/%(?:2B|2F|3D)/g, decodeURIComponent)))
          );
        } catch (e) {
          return null;
        }
      }

      function extractUrlFromText(text) {
        if (!text) return null;
        var match = text.match(
          /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,24}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)+/i
        );
        log("Text to extract URL from: " + (text ? text.substring(0, 50) + "..." : "null"));
        var extracted = match ? match[0] : null;
        log("Extracted URL: " + extracted);
        return extracted;
      }

      function getRedirectUrl(issueData) {
        if (!issueData) return null;

        var base64Body = decodeBase64(issueData.body || "");
        var base64Title = decodeBase64(issueData.title || "");

        var candidate =
          extractUrlFromText(base64Body) ||
          extractUrlFromText(issueData.body) ||
          extractUrlFromText(base64Title) ||
          extractUrlFromText(issueData.title) ||
          null;
        log("Redirect candidate: " + candidate);
        return candidate;
      }

      function tryRedirectByIssue(issueData, location, homepage) {
        if (!issueData || issueData.message === "Not Found") {
          log("Issue data not found or invalid", "error");
          return false;
        }

        var redirectUrl = getRedirectUrl(issueData);
        if (!redirectUrl) {
          log("No URL found in issue", "error");
          return false;
        }

        // Workaround IE 11 lack of support for new URL()
        var url = document.createElement("a");
        url.setAttribute("href", redirectUrl);

        // MODIFIED: Original code blocked redirection to the same hostname.
        if (url.href === location.href) {
             log("Target URL is identical to current location. Aborting to prevent loop.");
             showMessage("Target URL loop detected.", true);
             return false;
        }
        
        // Success
        log("Redirecting to: " + redirectUrl);
        location.replace(redirectUrl);
        return true;
      }

      function searchIssueByTitle(shortUrl, location, homepage) {
        var searchXhr = new XMLHttpRequest();

        searchXhr.onload = function () {
          try {
            var payload = JSON.parse(searchXhr.response);
            var items = payload && payload.items ? payload.items : [];

            if (items.length > 0) {
              var matchedIssue = null;
              for (var i = 0; i < items.length; i++) {
                if (items[i].title.toLowerCase() === shortUrl.toLowerCase()) {
                  matchedIssue = items[i];
                  break;
                }
              }

              if (matchedIssue && tryRedirectByIssue(matchedIssue, location, homepage)) {
                return;
              }
            }

            log("No matching issue found for title: " + shortUrl);
            showMessage("Link not found", true);
            
          } catch (e) {
            log("Error parsing search response: " + e);
            showMessage("Error searching for link", true);
          }
        };

        searchXhr.onerror = function () {
           log("Search XHR error");
           showMessage("Connection error", true);
        };

        var repoPath = GITHUB_ISSUES_LINK.replace(/https:\/\/api\.github\.com\/repos\//, "").replace(/\/issues\/$/, "");
        var query = "repo:" + repoPath + " in:title " + shortUrl;
        log("Searching issues with query: " + query);
        searchXhr.open("GET", "https://api.github.com/search/issues?q=" + encodeURIComponent(query));
        searchXhr.send();
      }

      function redirect() {
        var location = window.location;
        var pathParts = location.pathname.split("/");
        
        var skip =
          PATH_SEGMENTS_TO_SKIP !== null
            ? PATH_SEGMENTS_TO_SKIP
            : (pathParts[1] && pathParts[1].toLowerCase() === 'url')
            ? 1
            : /\.github\.io$/i.test(location.hostname)
            ? 1
            : 0;
        
        log("Redirect script loaded");
        
        var shortUrl = pathParts[skip + 1];

        // Clean trailing slash if present
        if (!shortUrl && pathParts.length > skip + 1) {
             // Maybe it was url/123/
             if (pathParts[skip+1] === "" && pathParts[skip]) {
                 // edge case
             }
        }
        
        var homepage =
          location.protocol +
          "//" +
          location.hostname +
          (location.port ? ":" + location.port : "") +
          "/" +
          pathParts[skip];

        if (!shortUrl) {
          log("No short URL key detected.");
          // If no key, just go to homepage or show 404
          window.location.replace(homepage);
          return;
        }

        // First, try to treat shortUrl as an issue number
        if (/^\d+$/.test(shortUrl)) {
          log("Key looks like an issue number: " + shortUrl);
          var xhr = new XMLHttpRequest();

          xhr.onload = function () {
            try {
              var payload = JSON.parse(xhr.response);

              if (tryRedirectByIssue(payload, location, homepage)) {
                return;
              }
              
              log("Issue lookup by number failed, trying search...");
              searchIssueByTitle(shortUrl, location, homepage);
            } catch (e) {
              log("Error parsing issue lookup response: " + e);
              searchIssueByTitle(shortUrl, location, homepage);
            }
          };

          xhr.onerror = function () {
            log("Issue lookup XHR error");
            searchIssueByTitle(shortUrl, location, homepage);
          };

          xhr.open("GET", GITHUB_ISSUES_LINK + shortUrl);
          xhr.send();
        } else {
          // Not a number, search by title
          log("Key is not a number, searching by title...");
          searchIssueByTitle(shortUrl, location, homepage);
        }
      }
      
      window.onload = redirect;
    </script>
  </head>
  <body>
    <div class="container">
      <div class="error-icon"></div>
      <div class="spinner"></div>
      <div id="message">Redirecting...</div>
      <a href="/url/" class="home-btn">Go Home</a>
    </div>
  </body>
</html>
